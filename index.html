<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Climbfinder - Cycling Climbs Map</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/flatgeobuf@3.35.0/dist/flatgeobuf-geojson.min.js"></script>
  <style>
    :root {
      --hc: #7b1fa2; --c1: #d32f2f; --c2: #f57c00; --c3: #388e3c; --c4: #1976d2;
      --card: rgba(12,16,24,0.93); --text: #f0f4f8; --accent: #e63946;
      --border: rgba(255,255,255,0.10);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; overflow: hidden; }
    #map { position: absolute; inset: 0; }
    #bar {
      position: absolute; top: 0; left: 0; right: 0; z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 14px; gap: 10px;
      background: var(--card); border-bottom: 2px solid var(--accent); color: var(--text);
    }
    #logo { display: flex; align-items: center; gap: 8px; font-size: 17px; font-weight: 700; }
    #filters { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
    #filters label { font-size: 11px; color: #aaa; margin-right: 2px; }
    .cb { display: none; }
    .cb-lbl { padding: 4px 11px; border-radius: 20px; font-size: 12px; font-weight: 700;
              cursor: pointer; transition: opacity .2s; color: #fff; user-select: none; }
    .cb:not(:checked) + .cb-lbl { opacity: 0.28; }
    .cb-hc+.cb-lbl{background:var(--hc)} .cb-1+.cb-lbl{background:var(--c1)}
    .cb-2+.cb-lbl{background:var(--c2)}  .cb-3+.cb-lbl{background:var(--c3)}
    .cb-4+.cb-lbl{background:var(--c4)}
    #loader { font-size: 11px; color: #aaa; white-space: nowrap; }
    #panel {
      position: absolute; top: 52px; right: 10px; width: 290px; z-index: 20;
      background: var(--card); border-radius: 10px; overflow: hidden;
      box-shadow: 0 6px 28px rgba(0,0,0,.55);
      transform: translateX(310px); transition: transform .28s cubic-bezier(.4,0,.2,1);
      color: var(--text);
    }
    #panel.open { transform: translateX(0); }
    #ph { display: flex; align-items: flex-start; padding: 12px 14px; gap: 9px;
          background: rgba(255,255,255,.04); border-bottom: 1px solid var(--border); }
    #ph h3 { flex: 1; font-size: 14px; line-height: 1.35; }
    #ph-cat { padding: 3px 9px; border-radius: 12px; font-size: 11px; font-weight: 800; }
    #ph-close { background: none; border: none; color: #888; font-size: 21px; line-height: 1; cursor: pointer; }
    #ph-close:hover { color: #fff; }
    #stats { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border-bottom: 1px solid var(--border); }
    .st { background: var(--card); padding: 11px 13px; }
    .st-v { font-size: 21px; font-weight: 700; color: var(--accent); }
    .st-l { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: .4px; }
    #tags { padding: 9px 12px; display: flex; flex-wrap: wrap; gap: 5px; border-bottom: 1px solid var(--border); }
    .tag { padding: 3px 9px; border-radius: 10px; background: rgba(255,255,255,.09); font-size: 11px; color: #ccc; }
    #acts { padding: 11px 13px; display: flex; flex-direction: column; gap: 7px; }
    .btn { display: block; padding: 9px; border-radius: 7px; font-size: 13px; font-weight: 600;
           text-align: center; text-decoration: none; border: none; cursor: pointer; transition: opacity .2s; }
    .btn:hover { opacity: .82; }
    .btn-p { background: var(--accent); color: #fff; }
    .btn-s { background: rgba(255,255,255,.10); color: var(--text); }
    #legend {
      position: absolute; bottom: 32px; left: 10px; z-index: 10;
      background: var(--card); border-radius: 8px; padding: 11px 13px; color: var(--text); font-size: 12px;
    }
    #legend h4 { font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: #aaa; margin-bottom: 8px; }
    .lr { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .ll { border-radius: 2px; flex-shrink: 0; }
    .lsep { border-top: 1px solid var(--border); margin: 8px 0; }
    #sv { position: absolute; bottom: 32px; right: 310px; width: 370px; height: 230px; z-index: 30;
          background: #000; border-radius: 9px; overflow: hidden; box-shadow: 0 4px 22px rgba(0,0,0,.6); display: none; }
    #sv iframe { width: 100%; height: 100%; border: 0; }
    #sv-close { position: absolute; top: 6px; right: 8px; z-index: 1; background: rgba(0,0,0,.6);
                color: #fff; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; }
    @media (max-width: 560px) { #panel { width: calc(100vw - 20px); } #sv { right:10px; width:calc(100vw - 20px); } }
  </style>
</head>
<body>
<div id="bar">
  <div id="logo">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <path d="M2 18 L6 10 L12 14 L18 4 L22 8" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="22" cy="8" r="2" fill="var(--accent)"/>
    </svg>
    Climbfinder
  </div>
  <div id="filters">
    <label><span id="cat-label">Category:</span></label>
    <input type="checkbox" id="f-hc" class="cb cb-hc" checked><label for="f-hc" class="cb-lbl">HC</label>
    <input type="checkbox" id="f-1"  class="cb cb-1"  checked><label for="f-1"  class="cb-lbl">1</label>
    <input type="checkbox" id="f-2"  class="cb cb-2"  checked><label for="f-2"  class="cb-lbl">2</label>
    <input type="checkbox" id="f-3"  class="cb cb-3"  checked><label for="f-3"  class="cb-lbl">3</label>
    <input type="checkbox" id="f-4"  class="cb cb-4"  checked><label for="f-4"  class="cb-lbl">4</label>
  </div>
  <span id="loader"></span>
</div>

<div id="map"></div>

<div id="panel">
  <div id="ph">
    <span id="ph-cat"></span><h3 id="ph-name"></h3>
    <button id="ph-close">x</button>
  </div>
  <div id="stats">
    <div class="st"><div class="st-v" id="s-grad">-</div><div class="st-l">Gradient %</div></div>
    <div class="st"><div class="st-v" id="s-len">-</div><div class="st-l">Length km</div></div>
    <div class="st"><div class="st-v" id="s-asc">-</div><div class="st-l">Elevation m</div></div>
    <div class="st"><div class="st-v" id="s-score">-</div><div class="st-l">Score</div></div>
  </div>
  <div id="tags"></div>
  <div id="acts">
    <a id="btn-cf" class="btn btn-p" href="#" target="_blank">View on Climbfinder</a>
    <button id="btn-sv" class="btn btn-s">Google Street View</button>
  </div>
</div>

<div id="sv"><button id="sv-close">x</button><div id="sv-inner"></div></div>

<div id="legend">
  <h4>Climb difficulty</h4>
  <div class="lr"><div class="ll" style="width:28px;height:5px;background:var(--hc)"></div>Hors Categorie</div>
  <div class="lr"><div class="ll" style="width:28px;height:4px;background:var(--c1)"></div>Categorie 1</div>
  <div class="lr"><div class="ll" style="width:28px;height:3px;background:var(--c2)"></div>Categorie 2</div>
  <div class="lr"><div class="ll" style="width:28px;height:3px;background:var(--c3)"></div>Categorie 3</div>
  <div class="lr"><div class="ll" style="width:28px;height:2px;background:var(--c4)"></div>Categorie 4</div>
  <div class="lsep"></div>
  <div class="lr" style="color:#aaa">width = gradient %</div>
  <div class="lr" style="color:#aaa">arrow = uphill direction</div>
</div>

<script>
const CAT_COLORS = { HC:'#7b1fa2','1':'#d32f2f','2':'#f57c00','3':'#388e3c','4':'#1976d2' };

const catExpr   = ['match',['get','category'],'HC','#7b1fa2','1','#d32f2f','2','#f57c00','3','#388e3c','4','#1976d2','#999'];
const widthExpr = ['interpolate',['linear'],['coalesce',['get','gradient'],5],0,1.5,5,2.5,8,4,10,5.5,15,7,20,9];


const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tiles.openfreemap.org/styles/liberty',
  center: [5.0, 46.5], zoom: 5, hash: true
});
map.addControl(new maplibregl.NavigationControl(), 'top-right');
map.addControl(new maplibregl.ScaleControl({ unit:'metric' }), 'bottom-left');

async function loadFGB(url, bbox) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(url + ': ' + res.status);
  const features = [];
  const rect = bbox ? { minX:bbox[0], minY:bbox[1], maxX:bbox[2], maxY:bbox[3] } : undefined;
  for await (const f of flatgeobuf.deserialize(res.body, rect)) features.push(f);
  return { type:'FeatureCollection', features };
}

let loading = 0;
function setLoad(d) {
  loading += d;
  document.getElementById('loader').textContent = loading > 0 ? 'Loading...' : '';
}

function activeCats() {
  return ['HC','1','2','3','4'].filter(c => document.getElementById('f-'+c.toLowerCase()).checked);
}

function filterFC(fc) {
  const cats = activeCats();
  if (cats.length === 5) return fc;
  return { ...fc, features: fc.features.filter(f => cats.includes(f.properties && f.properties.category)) };
}

async function refreshClimbs() {
  if (!map.getSource('climblines')) return;
  const b = map.getBounds();
  const bbox = [b.getWest(), b.getSouth(), b.getEast(), b.getNorth()];
  const zoom = map.getZoom();
  setLoad(1);
  try { map.getSource('climbpoints').setData(filterFC(await loadFGB('data/climbpoints.fgb', bbox))); }
  catch(e) { console.warn(e); } finally { setLoad(-1); }
  if (zoom >= 11) {
    setLoad(1);
    try { map.getSource('climblines').setData(filterFC(await loadFGB('data/climblines.fgb', bbox))); }
    catch(e) { console.warn(e); } finally { setLoad(-1); }
  }
}

const empty = { type:'FeatureCollection', features:[] };

map.on('load', async () => {


  map.addSource('climblines',  { type:'geojson', data: empty });
  map.addSource('climbpoints', { type:'geojson', data: empty });
  map.addSource('localities',  { type:'geojson', data: empty });
  map.addSource('nearby',      { type:'geojson', data: empty });

  map.addLayer({ id:'lines-shadow', type:'line', source:'climblines', minzoom:11,
    layout:{'line-join':'round','line-cap':'round'},
    paint:{'line-color':'#000','line-blur':3,'line-opacity':0.3,
      'line-width':['interpolate',['linear'],['coalesce',['get','gradient'],5],0,5,5,7,10,11,20,15]}
  });
  map.addLayer({ id:'lines', type:'line', source:'climblines', minzoom:11,
    layout:{'line-join':'round','line-cap':'round'},
    paint:{'line-color':catExpr,'line-width':widthExpr,'line-opacity':0.92}
  });
  map.addLayer({ id:'lines-gravel', type:'line', source:'climblines', minzoom:11,
    filter:['any',['==',['get','Gravel'],1],['==',['get','cobbles'],1]],
    paint:{'line-color':'#fff','line-width':1.2,'line-opacity':0.3,'line-dasharray':[3,4]}
  });
  map.addLayer({ id:'arrows', type:'symbol', source:'climblines', minzoom:10,
    layout:{
      'symbol-placement':'line',
      'symbol-spacing':120,
      'text-field':'▶',
      'text-font':['Noto Sans Regular'],
      'text-size':14,
      'text-rotation-alignment':'map',
      'text-keep-upright':false
    },
    paint:{
      'text-color':'#222',
      'text-halo-color':'#fff',
      'text-halo-width':2
    }
  });
  map.addLayer({ id:'points', type:'circle', source:'climbpoints',
    paint:{'circle-color':catExpr,'circle-radius':7,'circle-stroke-color':'#fff','circle-stroke-width':2}
  });
  map.addLayer({ id:'locs', type:'symbol', source:'localities',
    layout:{
      'text-field':['coalesce',['get','name'],''],
      'text-font':['Noto Sans Regular'],
      'text-size':['interpolate',['linear'],['zoom'],4,10,8,14]
    },
    paint:{'text-color':'#333','text-halo-color':'#fff','text-halo-width':2}
  });
  map.addLayer({ id:'nearby-pts', type:'circle', source:'nearby', minzoom:10,
    paint:{'circle-color':'#1565c0','circle-radius':5,'circle-stroke-color':'#fff','circle-stroke-width':1.5}
  });

  ['lines','points'].forEach(l => {
    map.on('mouseenter', l, () => map.getCanvas().style.cursor='pointer');
    map.on('mouseleave', l, () => map.getCanvas().style.cursor='');
    map.on('click', l, e => showPanel(e.features[0].properties, e.lngLat));
  });
  map.on('click', e => {
    if (!map.queryRenderedFeatures(e.point,{layers:['lines','points']}).length) closePanel();
  });

  setLoad(1);
  try { map.getSource('localities').setData(await loadFGB('data/localities.fgb')); }
  catch(e) { console.warn(e); } finally { setLoad(-1); }

  setLoad(1);
  try { map.getSource('nearby').setData(await loadFGB('data/nearby.fgb')); }
  catch(e) { console.warn(e); } finally { setLoad(-1); }

  map.on('moveend', refreshClimbs);
  refreshClimbs();
});

let _ll = null;
function showPanel(p, ll) {
  _ll = ll;
  const cat = p.category || '?';
  document.getElementById('ph-cat').textContent = cat;
  document.getElementById('ph-cat').style.background = CAT_COLORS[cat] || '#555';
  document.getElementById('ph-name').textContent = p.name || ('Klim #' + p.id);
  document.getElementById('s-grad').textContent  = p.gradient  != null ? p.gradient.toFixed(1)+'%' : '-';
  document.getElementById('s-len').textContent   = p.length    != null ? (p.length/1000).toFixed(1) : '-';
  document.getElementById('s-asc').textContent   = p.ascent    != null ? Math.round(p.ascent)+'m'   : '-';
  document.getElementById('s-score').textContent = p.reviewScore != null ? p.reviewScore.toFixed(1)+' ★' : '-';
  const t = document.getElementById('tags'); t.innerHTML = '';
  if (p.gravel==1)  addTag(t,'Gravel');
  if (p.cobbles==1) addTag(t,'Cobblestones');
  if (p.hairpins>0) addTag(t,p.hairpins+' hairpins');
  if (p.famous==1)  addTag(t,'Famous');
  if (p.reviews>0)  addTag(t,p.reviews+' reviews');
  const cfUrl = _ll
    ? `https://climbfinder.com/en/map#14/${_ll.lat.toFixed(5)}/${_ll.lng.toFixed(5)}`
    : '#';
  document.getElementById('btn-cf').href = cfUrl;
  document.getElementById('panel').classList.add('open');
}
function closePanel() {
  document.getElementById('panel').classList.remove('open');
  document.getElementById('sv').style.display = 'none';
}
function addTag(c,t) { const s=document.createElement('span'); s.className='tag'; s.textContent=t; c.appendChild(s); }
document.getElementById('ph-close').onclick = closePanel;

document.getElementById('btn-sv').onclick = () => {
  if (!_ll) return;
  const u = 'https://www.google.com/maps/embed/v1/streetview?key=YOUR_GOOGLE_MAPS_API_KEY&location='+_ll.lat+','+_ll.lng+'&fov=90';
  document.getElementById('sv-inner').innerHTML = '<iframe src="'+u+'" allowfullscreen></iframe>';
  document.getElementById('sv').style.display = 'block';
};
document.getElementById('sv-close').onclick = () => document.getElementById('sv').style.display='none';

['hc','1','2','3','4'].forEach(c =>
  document.getElementById('f-'+c).addEventListener('change', refreshClimbs)
);
</script>
</body>
</html>

